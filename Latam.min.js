var menorPreco = { valor: 999999.9, destino: "", achados: [], link: "", melhor: { flightCode: "" } }, normalPreco = { valor: 999999.9, destino: "", achados: [], link: "", melhor: { flightCode: "" } }; function resetGlobals() { menorPreco = { valor: 999999.9, destino: "", achados: [], melhor: { flightCode: "" }, link: "" }, normalPreco = { valor: 999999.9, destino: "", achados: [], melhor: { flightCode: "" }, link: "" }, $("#rConsulta").html(""), $("#rOriginal").html("") } var places = []; function RenderTela() { $.ajax({ url: "https://www.latam.com/ws/api/booking-box/v2/originsBB?airline=tam&portal=pessoas&application=compra&country=BR&language=pt", type: "GET", dataType: "json", success: function (a) { for (var o = '<option value="">Selecione</option>', r = 0; r < a.data.places.length; r++)p = a.data.places[r], 0 < p.label.indexOf("Brasil") && (places.push(p), o += '<option value="' + p.iataCode + '">' + p.label + "</option>"); msg = '<p><table border="0">' + ('<tr><td> Origem: </td> <td><select id="cbnOrigem">' + o + "</select></td></tr>") + ('<tr><td> Destino: </td> <td><select id="cbnDestino">' + o + "</select></td></tr>") + '<tr><td> Data de Ida: </td> <td><input id="txtDtIda" value="2018-09-09"> (ano-mes-dia)</td></tr></table><strong id="rStatus" class="week-day-string">Consulta Interna</strong><br><input type="button" value="Consultar Normal" onclick="doConsultaNormal()"><input type="button" value="Consultar Melhor Preço" onclick="doConsulta()"><br>Pesquisa Escalas: <spam id="rConsulta"></spam><br>Pesquisa Normal <spam id="rOriginal"></spam><br> </p>', $("<div/>", { html: msg, id: "dvPrincipal", class: "ranking-table", css: { width: "90%" }, insertBefore: ".flight-selection-instruction" }), $(".itinerary-route").html("Consulta Personalizada!"), $(".trip-summary").html("-") }, error: function (a, o) { console.log(o) } }) } function doConsultaNormal() { resetGlobals(); var a = $("#cbnOrigem").val(), o = $("#cbnDestino").val(), r = $("#txtDtIda").val(); text = "Aguarde Consultando..", refreshIntervalId = setInterval(function () { $("#rStatus").html(text + Array(++i % 4 + 1).join(".")) }, 500), GetNormalPrice(a, o, r) } function doConsulta() { resetGlobals(); var a = $("#cbnOrigem").val(), o = $("#cbnDestino").val(), r = $("#txtDtIda").val(); text = "Aguarde Consultando..", refreshIntervalId = setInterval(function () { $("#rStatus").html(text + Array(++i % 4 + 1).join(".")) }, 500), GetNormalPrice(a, o, r), FindBestPrice(a, o, r) } function FindBestPrice(a, o, r) { for (var e = 0; e < places.length; e++)p = places[e], p.iataCode !== o && GetPrice(a, p.iataCode, o, r) } function formataDinheiro(a) { return "R$ " + a.toFixed(2).replace(".", ",").replace(/(\d)(?=(\d{3})+\,)/g, "$1.") } function mostraMenor() { var a = 100 - menorPreco.valor / normalPreco.valor * 100, o = menorPreco.destino + " (" + menorPreco.melhor.flightCode + ") por: <b>" + formataDinheiro(menorPreco.valor) + "</b> (" + a.toFixed(2) + "% OFF) "; 999999.9 === menorPreco.valor && (o = "Nenuma escala foi encontrada para esta consulta"), o += printTable(menorPreco.achados), o += '<a class="week-day-selector" target="_new" href="' + menorPreco.link + '">Link</a>', $("#rConsulta").html(o) } function printTable(a) { var o = ""; if (a) { var r = ""; nAchados = a.length, a.sortByPreco = function () { this.sort(function (a, o) { return a.cabins[0].displayPrice - o.cabins[0].displayPrice }) }, a.sortByPreco(), 3 <= nAchados && (nAchados = 3); for (var e = 0; e < nAchados; e++) { var t = a[e]; r += '<tr><td style="padding: 2px;">' + e + " - " + t.arrival.airportCode + '</td><td style="padding: 2px;"><b>' + formataDinheiro(t.cabins[0].displayPrice) + '</b></td><td style="padding: 2px;">' + t.flightCode + '</td><td style="padding: 2px;">' + t.arrival.time.stamp + "</td></tr>" } o = '<br>Melhores Resultados:<table border="1" cellpadding ="1"><tr><td>Destino</td><td>Preço</td><td>Voo</td><td>Chegada</td></tr>' + r + "</table>" } return o } function mostraNormal() { var a = normalPreco.destino + " (" + normalPreco.melhor.flightCode + ") <b>" + formataDinheiro(normalPreco.valor) + "</b> "; a += printTable(normalPreco.achados), a += '<a class="week-day-selector" target="_new" href="' + normalPreco.link + '">Link</a>', $("#rOriginal").html(a) } function GetNormalPrice(a, n, o) { var r = "BR", e = "PT", t = "pt_br", l = a, i = n, s = o, c = 1, d = "Y", m = o.slice(-2), p = o.substring(0, 7), u = "https://bff.latam.com/ws/proxy/booking-webapp-bff/v1/public/revenue/recommendations/oneway?country=" + r + "&language=" + e + "&home=" + t + "&origin=" + l + "&destination=" + i + "&departure=" + s + "&adult=" + c + "&cabin=" + d; $.ajax({ url: u, type: "GET", dataType: "json", success: function (a) { for (var o = 0; o < a.data.flights.length; o++) { var r = a.data.flights[o], e = parseFloat(r.cabins[0].displayPrice); if (normalPreco.valor > e) { normalPreco.valor = e, normalPreco.destino = n, normalPreco.melhor = r; var t = "https://www.latam.com/pt_br/apps/personas/booking?fecha1_dia=" + m + "&fecha1_anomes=" + p + "&auAvailability=1&ida_vuelta=ida&from_city1=" + l + "&to_city1=" + n + "&flex=1&cabina=Y&nadults=1&nchildren=0&ninfants=0"; normalPreco.link = t, mostraNormal() } normalPreco.achados.push(r) } }, error: function (a, o) { console.log(o) } }) } function GetPrice(a, i, s, o) { if (i !== s) { var r = "BR", e = "PT", t = "pt_br", c = a, n = i, l = o, d = 1, m = "Y", p = o.slice(-2), u = o.substring(0, 7), h = "https://bff.latam.com/ws/proxy/booking-webapp-bff/v1/public/revenue/recommendations/oneway?country=" + r + "&language=" + e + "&home=" + t + "&origin=" + c + "&destination=" + n + "&departure=" + l + "&adult=" + d + "&cabin=" + m; $.ajax({ url: h, type: "GET", dataType: "json", success: function (a) { for (var o = 0; o < a.data.flights.length; o++)for (var r = a.data.flights[o], e = r.segments, t = 0; t < e.length; t++) { if (e[t].arrival.airportCode === s) { var n = parseFloat(r.cabins[0].displayPrice); if (menorPreco.valor > n) { console.log(menorPreco.valor + "--\x3e" + n), menorPreco.valor = n, menorPreco.destino = i, menorPreco.melhor = r; var l = "https://www.latam.com/pt_br/apps/personas/booking?fecha1_dia=" + p + "&fecha1_anomes=" + u + "&auAvailability=1&ida_vuelta=ida&from_city1=" + c + "&to_city1=" + i + "&flex=1&cabina=Y&nadults=1&nchildren=0&ninfants=0"; menorPreco.link = l, mostraMenor() } menorPreco.achados.push(r) } } }, error: function (a, o) { console.log(o) } }) } } g_csLoaded = !0, refreshIntervalId = 0, $(document).ajaxStop(function () { mostraNormal(), mostraMenor(), clearInterval(refreshIntervalId), $("#rStatus").html("Concluído!") }), RenderTela();